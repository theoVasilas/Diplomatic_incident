import os
import subprocess

def run_flower_env(what_to_run):
    # Function to get the current Conda environment
    def get_conda_env():
        try:
            result = subprocess.run(
                "conda info --envs",
                shell=True,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                universal_newlines=True
            )
            if result.returncode == 0:
                for line in result.stdout.splitlines():
                    y = line.find("*")
                    if y != -1:  
                        return line[:y].strip()
            return None  
        except Exception as e:
            print(f"Error checking conda environment: {e}")
            return None

    subprocess.run("clear", shell=True, executable="/bin/bash")
    # Get the current Conda environment
    current_env = get_conda_env()
    print(f"Current environment: {current_env}")

    # Check if the current environment is flower_env
    if current_env == "flower_env":
        print("Environment is already flower_env. Running main.py...")
    else:
        print("Not in flower_env. Checking environment state...")

        if current_env == "base":
            # subprocess.run("conda init", shell=True)
            print("Activating flower_env...")
            # subprocess.run("conda init", shell=True, executable="/bin/bash")
            subprocess.run("conda activate flower_env", shell=True, executable="/bin/bash")
        else:
            print(f"Deactivating {current_env} and activating flower_env...")
            subprocess.run("conda deactivate", shell=True, executable="/bin/bash")
            subprocess.run("conda activate base", shell=True, executable="/bin/bash")
        
        subprocess.run("conda activate flower_env", shell=True, executable="/bin/bash")


    # Detect the current working directory
    current_directory = os.getcwd()
    desired_directory = "/home/theo_ubuntu/Diplomatic_incident/flwr_hydra"

    # Change directory if not in the desired folder
    if current_directory != desired_directory:
        print(f"Changing directory from {current_directory} to {desired_directory}...")
        os.chdir(desired_directory)

    # Confirm the directory change
    print(f"Current directory: {os.getcwd() }\n\n")

    # Run the command stored in 'what_to_run'
    subprocess.run(what_to_run, shell=True)

run_flower_env("python main.py")
